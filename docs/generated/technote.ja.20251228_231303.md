+++
title = "Technical Note: The Physics of Conchordal"
date = 2025-12-25
description = "A deep dive into the psychoacoustic algorithms, logarithmic signal processing, and artificial life strategies powering the Conchordal ecosystem."
template = "page.html"
[extra]
source_commit = "9f8efe7"
author = "Koichi Takahashi"
last_updated = "2025-12-28"
source_version = "0.1.0"
source_snapshot = "2025-12-28T23:07:19+09:00"
generated_by = "opus"
+++

# 1. はじめに：生物音響パラダイム

Conchordal は、生成音楽および計算オーディオの既存規範から根本的に逸脱したシステムである。従来のシステムが記号操作—量子化されたピッチ（MIDI、平均律）の格子と離散化された時間（BPM、小節）上での操作—に依存するのに対し、Conchordal は聴覚知覚の連続的かつ生物学的基盤に立脚したシミュレーションとして機能する。本システムは、音楽構造が抽象的な作曲の産物ではなく、音響的生存の創発的特性であるという立場をとる。

本技術ノートは、システムのアーキテクチャ、信号処理アルゴリズム、および人工生命戦略に関する包括的なリファレンスとして機能する。Conchordal が心理音響学の原理—具体的には臨界帯域理論、仮想ピッチ知覚、神経引き込み—を自律的エコシステムのダイナミクスといかに統合しているかを詳述する。この環境において、音は生きた有機体、すなわち代謝、感覚処理能力、そして過酷なスペクトル地形を自律的に航行する能力を持つ「個体（Individual）」として扱われる。

システムの創発的振る舞いは、統一された適応度関数：協和性（Consonance）の追求によって駆動される。Conchordal エコシステム内のエージェントは事前に書かれた楽譜に従わない。代わりに、環境を継続的に分析し、「スペクトル快適性」—感覚的粗さの最小化として定義される—と「調和安定性」—仮想基音の強度の最大化—を最大化しようとする。その結果、決定論的なシーケンシングではなく、物理法則の相互作用を通じて調和、リズム、音色が有機的に進化する自己組織化サウンドスケープが生まれる。

本文書では、Conchordal アーキテクチャの三つの基盤となる柱を探求する：

1.  **心理音響座標系**：線形ヘルツと整数 MIDI ノートを置き換える `Log2Space` と ERB スケールの数学的フレームワーク。
2.  **認知ランドスケープ**：生のオーディオストリームから粗さ（$R$）と調和性（$H$）フィールドを計算するリアルタイム DSP パイプライン。
3.  **生命エンジン**：オーディオエンティティの代謝、移動、神経引き込みを制御するエージェントベースモデル。

# 2. 心理音響座標系

Conchordal における重要な革新は、内部処理における線形周波数スケール（$f$）の拒否である。人間の聴覚知覚は本質的に対数的であり、我々のピッチ間隔の知覚は周波数の差ではなく比に基づいている。これを正確かつ効率的にモデル化するため、Conchordal は蝸牛のトノトピックマップに計算グリッドを整合させる独自の座標系 `Log2Space` を確立する。

## 2.1 Log2 Space の基礎

`Log2Space` 構造体は、システム内のすべてのスペクトル分析、カーネル畳み込み、エージェント位置決定の基盤として機能する。物理的周波数領域（Hz 単位の $f$）を知覚的対数領域（$l$）にマッピングする。

### 2.1.1 数学的定義

ヘルツから内部対数座標への変換は、周波数の底2の対数として定義される。この選択は意図的である：底2では、1.0 の増分がちょうど1オクターブ—ピッチ知覚における最も基本的な音程—に対応する。

$$ l(f) = \log_2(f) $$

オーディオスレッドの合成パラメータを導出するために使用される逆変換は：

$$ f(l) = 2^l $$

座標空間は解像度パラメータ `bins_per_oct`（$B$）で定義されるグリッドに離散化される。このパラメータはシミュレーションの粒度を決定する。$B=48$ または $B=96$ の典型値は、連続的なピッチグライドや微分音変化に十分な半音以下の解像度を提供する。ステップサイズ $\Delta l$ はスペクトル範囲全体で一定である：

$$ \Delta l = \frac{1}{B} $$

### 2.1.2 グリッド構築とインデックス化

`Log2Space` 構造体は、設定された範囲 $[f_{min}, f_{max}]$ に及ぶすべてのビンの中心周波数を事前計算する。ビン数 $N$ は完全なカバレッジを確保するよう決定される：

$$ N = \lfloor \frac{\log_2(f_{max}) - \log_2(f_{min})}{\Delta l} \rfloor + 1 $$

システムは DSP 操作中の $O(1)$ アクセスのために二つの並列ベクトルを維持する：

*   `centers_log2`：対数座標 $l_i = \log_2(f_{min}) + i \cdot \Delta l$。
*   `centers_hz`：事前計算された線形周波数 $f_i = 2^{l_i}$。

この事前計算はリアルタイム性能に不可欠であり、スペクトルカーネルの内部ループ内での高コストな `log2` および `pow` 呼び出しを排除する。メソッド `index_of_freq(hz)` は量子化ロジックを提供し、任意の浮動小数点周波数を最近傍ビンインデックスにマッピングする。

## 2.2 Constant-Q 帯域幅特性

`Log2Space` はスペクトル全体にわたって Constant-Q（一定品質係数）特性を本質的に強制する。信号処理用語では、$Q$ は中心周波数と帯域幅の比として定義される：$Q = f / \Delta f$。

線形システム（標準的な FFT のような）では $\Delta f$ が一定であり、$Q$ は周波数とともに増加する。`Log2Space` では、$i$ 番目のビンの帯域幅 $\Delta f_i$ は中心周波数 $f_i$ に比例してスケールする。この特性は人間の聴覚系の周波数選択性を模倣しており、耳の周波数分解能力は周波数が上がるにつれて（絶対 Hz で）低下する。この整合により、Conchordal は手動のマルチレート処理なしに、高周波では高い時間分解能、低周波では高いスペクトル分解能を用いて計算リソースを効率的に配分できる。

## 2.3 等価矩形帯域幅（ERB）スケール

`Log2Space` はピッチ関係（オクターブ、倍音）を扱うが、純粋な対数マッピングが示唆するよりも低周波で広い耳の臨界帯域を完全にはモデル化しない。感覚的粗さ（不協和）を正確に計算するため、Conchordal は Glasberg & Moore（1990）モデルに基づく等価矩形帯域幅（ERB）スケールを実装する。

`core/erb.rs` モジュールは Roughness Kernel で使用される変換関数を提供する。周波数 $f$（Hz）から ERB レート単位 $E$ への変換は以下で与えられる：

$$ E(f) = 21.4 \log_{10}(0.00437f + 1) $$

周波数 $f$ における臨界帯域の帯域幅は：

$$ BW_{ERB}(f) = 24.7(0.00437f + 1) $$

このスケールは `Log2Space` とは異なる。`Log2Space` がピッチと調和性（関係がオクターブ不変である）の領域である一方、粗さ計算は干渉を評価するためにスペクトルエネルギーを ERB 領域にマッピングする必要がある。システムは効果的にスペクトルの二重視点を維持する：調和テンプレート用の厳密に対数的なものと、不協和評価用の心理音響的なものである。

# 3. 聴覚ランドスケープ：環境の分析

「ランドスケープ」は Conchordal の中心的データ構造である。すべてのエージェントの共有環境として機能し、各周波数ビンの心理音響的「ポテンシャル」を表す動的スカラー場である。エージェントは互いに直接相互作用しない；ランドスケープと相互作用し、ランドスケープが全個体群のスペクトルエネルギーを集約する。これによりシミュレーションの複雑さがエージェント数から切り離される（$O(N)$ vs $O(N^2)$）。

ランドスケープは各オーディオフレーム（またはブロック）ごとに Analysis Workers によって更新される。三つの主要指標を統合する：

*   **粗さ（$R$）**：近接する倍音間の急速なうなりによって引き起こされる感覚的不協和。
*   **調和性（$H$）**：仮想ピッチ強度とスペクトル周期性の尺度。
*   **慣れ（$\Psi$）**：聴覚疲労を表す負のフィードバックループ。

周波数 $f$ および時刻 $t$ における正味の協和性（$C$）は、エージェントがサンプルする適応度場である：

$$ C(f,t) = H(f,t) - k_r \cdot R(f,t) - w_h \cdot \Psi(f,t) $$

## 3.1 非定常ガボール変換（NSGT）

スペクトルデータで `Log2Space` を埋めるため、Conchordal は非定常ガボール変換（NSGT）のカスタム実装を使用する。固定窓サイズを使用する短時間フーリエ変換（STFT）とは異なり、NSGT はセクション 2.2 で導出した Constant-Q 特性を維持するため窓長 $L$ を周波数に反比例して変化させる。

### 3.1.1 カーネルベースのスペクトル分析

`core/nsgt_kernel.rs` の実装は、この変換を効率的に実行するためにスパースカーネルアプローチを利用する。各対数周波数帯域 $k$ に対して、時間領域カーネル $h_k$ が事前計算される。このカーネルは、帯域の中心周波数 $f_k$ における複素正弦波と長さ $L_k \approx Q \cdot f_s / f_k$ の周期的ハン窓 $w_k$ を組み合わせる。

$$ h_k[n] = w_k[n] \cdot e^{-j 2\pi f_k n / f_s} $$

これらのカーネルは初期化時に周波数領域（$K_k[\nu]$）に変換される。性能を最適化するため、システムはこれらの周波数カーネルをスパース化し、有意なエネルギーを持つビンのみを保存する。

実行時、システムは入力オーディオバッファに単一の FFT を実行してスペクトル $X[\nu]$ を取得する。帯域 $k$ の複素係数 $C_k$ は周波数領域での内積を介して計算される：

$$ C_k = \frac{1}{N_{fft}} \sum_{\nu} X[\nu] \cdot K_k^*[\nu] $$

この「1回の FFT、多数のカーネル」アプローチにより、Conchordal は各帯域に対する個別の DFT 計算や再帰フィルタバンクを使用せずに、20Hz から 20kHz をカバーする高解像度の対数間隔スペクトルを生成できる。

### 3.1.2 リアルタイム時間平滑化

生のスペクトル係数 $C_k$ は、オーディオ入力の確率的性質（特にノイズベースのエージェント）により高い分散を示す。エージェントがサンプルする安定した場を作成するため、`RtNsgtKernelLog2` 構造体は NSGT を時間平滑化レイヤーでラップする。

帯域ごとのリーキー積分器（指数平滑化）を実装する。重要なのは、時定数 $\tau$ が周波数依存であることである。ゆっくり進化する低周波はより長い $\tau$ で平滑化され、過渡的詳細を伝える高周波はより短い $\tau$ を持つ。

$$ y_k[t] = (1 - \alpha_k) \cdot |C_k[t]| + \alpha_k \cdot y_k[t-1] $$

ここで平滑化係数 $\alpha_k$ はフレーム間隔 $\Delta t$ から導出される：

$$ \alpha_k = e^{-\Delta t / \tau(f_k)} $$

これは耳の「積分時間」をモデル化し、ランドスケープが瞬間的な信号パワーではなく心理音響的知覚を反映することを保証する。

## 3.2 粗さ（$R$）計算：Plomp-Levelt モデル

粗さは、同じ臨界帯域内に含まれるが単一のトーンとして知覚されるほど十分に近くないスペクトル成分（うなり）の干渉によって引き起こされる「荒さ」または「ブザー音」の感覚である。Conchordal は ERB 領域での畳み込みを介して Plomp-Levelt モデルの変形を実装する。

### 3.2.1 干渉カーネル

計算の中核は `core/roughness_kernel.rs` で定義される Roughness Kernel である。このカーネル $K_{rough}(\Delta z)$ は $\Delta z$ ERB 離れた二つの倍音間の干渉曲線をモデル化する。曲線は倍音が離れるにつれて急速に上昇するペナルティを作成し、約 0.25 ERB（最大粗さ）でピークに達し、その後さらに離れると減衰する。

実装はパラメータ化された関数 `eval_kernel_delta_erb` を使用してこの形状を生成する：

$$ g(\Delta z) = e^{-\frac{\Delta z^2}{2\sigma^2}} \cdot (1 - e^{-(\frac{\Delta z}{\sigma_{suppress}})^p}) $$

第二項は $\Delta z \to 0$ としてカーネルがゼロになることを保証する抑制因子であり、単一の純音が自己粗さを生成することを防ぐ。

### 3.2.2 畳み込みアプローチ

すべてのスペクトルビンに対してペアワイズで粗さを計算すること（$N^2$ 複雑度）は、リアルタイムアプリケーションでは計算上禁止的である。Conchordal は粗さ計算を線形畳み込みとして扱うことでこれを解決する。

1.  **マッピング**：NSGT からの対数間隔振幅スペクトルが線形 ERB グリッドにマッピング（または補間）される。
2.  **畳み込み**：この密度 $A(z)$ が事前計算された粗さカーネル $K_{rough}$ と畳み込まれる。

$$ R(z) = (A * K_{rough})(z) = \int A(z-\tau) K_{rough}(\tau) d\tau $$

結果 $R(z)$ は周波数 $z$ における「粗さポテンシャル」を表す。エージェントが $z$ にトーンを配置した場合、既存のスペクトルエネルギーと相互作用して $R(z)$ に比例する粗さを生成する。協和性を求めるエージェントはこの場のピークを積極的に回避する。

## 3.3 調和性（$H$）：Sibling Projection アルゴリズム

粗さがエージェントを不協和から遠ざける（分離）一方、調和性（$H$）はエージェントを融合—首尾一貫した和音と音色の創造—に向かわせる。Conchordal はこの場を計算するために「Sibling Projection」と呼ばれる新しいアルゴリズムを導入する。このアルゴリズムは、脳の「共通基音」検出（仮想ピッチ）メカニズムを完全に周波数領域で近似する。

### 3.3.1 概念：仮想基音

アルゴリズムは、周波数 $f$ における任意のスペクトルピークがその下倍音（$f/2, f/3, f/4 \dots$）における基本周波数（基音）の潜在的存在を暗示すると仮定する。複数のスペクトルピークが共通の下倍音を共有する場合、その下倍音は強い「仮想基音」を表す。

### 3.3.2 2パス投影

アルゴリズムは対数グリッドの整数特性を利用して、`Log2Space` スペクトル上で2パスで動作する：

1.  **下向き投影（基音探索）**：現在のスペクトル包絡が下向きに「にじみ」出る。エネルギーを持つすべてのビン $i$ に対して、アルゴリズムは整数 $k \in \{1, 2, \dots, N\}$ についてビン $i - \log_2(k)$ にエネルギーを加算する。
    
    $$ Roots[i] = \sum_k A[i + \log_2(k)] \cdot w_k $$

    ここで $w_k$ は倍音インデックス $k$ とともに減衰する重み係数（例：$k^{-\rho}$）であり、低い倍音が高い倍音よりも強くその基音を暗示することを反映する。結果 `Roots` は各周波数における仮想ピッチの強度を記述する。

2.  **上向き投影（調和共鳴）**：次にシステムは `Roots` スペクトルを上向きに投影する。強い基音が $f_r$ に存在する場合、そのすべての自然倍音（$f_r, 2f_r, 3f_r \dots$）に安定性を暗示する。
    
    $$ H[i] = \sum_m Roots[i - \log_2(m)] \cdot w_m $$

**創発的調性安定性**：200 Hz に単一のトーンがある環境を考える。

*   **ステップ 1（下向き）**：100 Hz（$f/2$）、66.6 Hz（$f/3$）、50 Hz（$f/4$）などに基音を投影する。
*   **ステップ 2（上向き）**：100 Hz の基音は 100、200、300、400、500... Hz に安定性を投影する。
    *   300 Hz は 100 Hz 基音の完全5度。
    *   500 Hz は 100 Hz 基音の長3度。

したがって、西洋音楽理論のハードコードされた知識なしに、システムは倍音列の物理学の帰結として、長3度と完全5度の関係に自然に安定性ピークを生成する。200 Hz のエージェントは 300 Hz と 500 Hz に「重力井戸」を作り、他のエージェントが長三和音を形成するよう誘う。

### 3.3.3 鏡像二元性：上倍音 vs. 下倍音

`core/harmonicity_kernel.rs` の実装には深遠なパラメータ `mirror_weight`（$\alpha$）が含まれる。このパラメータは二つの異なる投影パスをブレンドする：

*   **パス A（上倍音/長調）**：上述した標準的な「下向き→上向き」投影。上倍音列に基づく重力を作り、長調の調性を好む。
*   **パス B（下倍音/短調）**：反転した「上向き→下向き」投影。共通の上倍音を見つけ、下倍音を投影する。これはパス A の理論的双対であり、短調またはフリギア調性（下倍音列）を好む。

$$ H_{final} = (1-\alpha)H_{overtone} + \alpha H_{undertone} $$

`mirror_weight` を変調することで、ユーザーは宇宙の基本物理を長調中心から短調中心へと連続的にモーフィングし、それに応じてエコシステムがどのように再編成されるかを観察できる。

## 3.4 慣れ：飽きメカニズム

システムが単一の最適和音（例：完全ユニゾンまたはオクターブ）を見つけて永遠にそこに留まることを防ぐため、Conchordal は慣れ（聴覚疲労）の生理学的モデルを実装する。

慣れ場はスペクトルエネルギーの履歴を追跡する。本質的には振幅スペクトルの非常に遅いリーキー積分器（時定数 $\tau_{hab}$ は通常 5–10 秒）である。

$$ \Psi[t] = (1-\beta) \cdot A[t] + \beta \cdot \Psi[t-1] $$

この場 $\Psi$ は最終的な協和性 $C$ から減算される。エージェントが周波数 $f$ に長く留まりすぎると、$\Psi(f)$ が増加し、$C(f)$ が減少し、かつて快適だった場所が「退屈」（低適応度）になる。これによりエージェントは新しい、新鮮な周波数に移動を余儀なくされ、音楽の永続的な進化を駆動する。

# 4. 生命エンジン：エージェントと自律性

「生命エンジン」は DSP ランドスケープ上で実行されるエージェントベースシミュレーション層である。「個体」の個体群を管理し、ライフサイクル、感覚処理、作動（オーディオ合成）を扱う。

## 4.1 個体アーキテクチャ

`Individual` 構造体（`life/individual.rs`）はエコシステムの原子単位である。4つのコンポーネントで構成される：`SoundBody` アクチュエータと3つの行動コア（Temporal、Field、Modulation）。

### 4.1.1 SoundBody（アクチュエータ）

`SoundBody` トレイトはエージェントの音生成能力を定義する。波形のレンダリングと、スペクトルフットプリントのシステムへの投影（ランドスケープ更新用）を担当する。

*   `SineBody`：純粋な正弦波トーンを合成。
*   `HarmonicBody`：基音と一連の倍音で構成される複合音を合成。このボディは `TimbreGenotype` の概念を導入し、以下のようなパラメータをエンコードする：
    *   `stiffness`：非調和係数（倍音列の伸張）。
    *   `brightness`：スペクトル勾配（高倍音の減衰）。
    *   `damping`：周波数依存の減衰率。
    *   `mode`：調和（整数倍）vs. 金属的（非整数比）。

`HarmonicBody` は音色の進化を可能にする。高い stiffness を持つエージェントは純粋に調和的なランドスケープでは生存が困難で、その非調和的倍音が個体群と衝突しない独自の「スペクトルニッチ」を探し出す必要がある。

### 4.1.2 コアスタック（Temporal、Field、Modulation）

行動は、それぞれ単一の制御軸を扱う3つの集中化されたコアに分割される：

*   **TemporalCore（いつ/ゲート）**：リズム、ゲーティング、エンベロープダイナミクスを管理。バリアントには `entrain`（`NeuralRhythms` への蔵本様同期）、`seq`（固定長エンベロープ）、`drone`（ゆっくりした揺れ）がある。
*   **FieldCore（どこ）**：協和性、距離ペナルティ、音域重力、満腹度に基づいて対数周波数空間での次のターゲットを提案。デフォルト実装は `pitch_hill_climb`。
*   **ModulationCore（どの程度）**：探索、持続性、慣れ感度などの変調パラメータを出力し、ターゲットやリズムを選択せずに他のコアにバイアスをかける。初期実装は `static`。

## 4.2 ライフサイクルと代謝

Conchordal のエージェントは生物学的代謝をモデル化したエネルギーダイナミクスに支配される。`LifecycleConfig` は二つの存在モードを定義する：

*   **Decay**：エージェントは固定の `initial_energy` プールで生まれる。時間とともに（半減期で）このエネルギーを消費し、ゼロに達すると死ぬ。撥弦やパーカッションのような過渡的な音をモデル化する。
*   **Sustain**：エージェントは `metabolism_rate`（1秒あたりのエネルギー損失）を持つが、`breath_gain` を介してエネルギーを獲得できる。
    *   **Breath Gain**：これが重要なフィードバックループである。エージェントがエネルギーを回復する率は現在の協和性の関数である。
    *   **生存**：不協和（低 $C$）領域のエージェントは「飢える」—エネルギーが枯渇し、振幅がフェードし、最終的に死ぬ。協和（高 $C$）領域のエージェントは「餌を得る」—エネルギーを維持または獲得し、より大きく歌い、より長く生きることができる。

このメカニズムはダーウィン的圧力を作り出す：**協和者の生存**。音楽構造が創発するのは、調和関係を見つけたエージェントだけが生き残って聞こえるからである。

## 4.3 場の再ターゲットロジック

エージェントは静的ではない；適応度を改善するために周波数空間を移動する。実行層（`Individual::update_field_target`）は再ターゲットゲート（シータゼロ交差と積分ウィンドウ）を適用し、次に FieldCore に次のターゲットの提案を求める。

1.  **再ターゲットゲート**：Individual は現在の周波数に基づいて時間を積分し、シータ交差がウィンドウと一致した場合にのみ発火する。これにより再ターゲットがリズミカルでスケール感度を持つ。
2.  **場の提案**：FieldCore（現在は `PitchHillClimb`）は現在のターゲット周辺の離散的な候補セットを評価する。各候補を協和性からペナルティ（距離、音域重力、スペクトル満腹度）を差し引いてスコアリングする。
3.  **変調の影響**：ModulationCore は持続性、探索、慣れ感度を供給する。これらのパラメータは改善が限界的な場合にエージェントが留まるかホップするかにバイアスをかけ、FieldCore は改善強度を反映する `salience` スコア（0..1）を返す。

移動は `Log2Space` でのホップポリシーを使用する：`breath_gain` を介してフェードアウトし、ピッチを新しいターゲットにスナップし、次にフェードインする。これにより連続的なポルタメントではなく離散的なジャンプが得られる。

# 5. 時間ダイナミクス：神経リズム

Conchordal はマスタークロックやメトロノームの概念を排除する。代わりに、時間は神経振動（脳波）に触発された連続的な変調場によって構造化される。これは「空間」ランドスケープの「時間」版である。

## 5.1 変調バンク

`NeuralRhythms` 構造体は生理学的周波数帯域に調整された共鳴フィルタのバンクを管理する：

*   **デルタ（0.5–4 Hz）**：エコシステムの巨視的「脈動」。このバンドにロックされたエージェントは長い、フレーズレベルの音符を演奏する。
*   **シータ（4–8 Hz）**：「アーティキュレーション」レート。音節リズムと中速モチーフを制御。
*   **アルファ（8–12 Hz）**：「テクスチャ」レート。トレモロ、ビブラート、きらめき効果に使用。
*   **ベータ（15–30 Hz）**：「緊張」レート。不協和や興奮に関連する高速フラッター。

## 5.2 活力と自己振動

各バンドはレゾネータ、減衰調和振動子として実装される。重要なパラメータは `vitality` である。

*   `Vitality = 0`：レゾネータは受動フィルタとして機能する。イベント（例：大音量エージェントのスポーン）で励起された場合のみ鳴り、その後減衰する。
*   `Vitality > 0`：レゾネータはアクティブゲインを持つ。入力がなくてもリズミカルなサイクルを維持して自己振動できる。

これにより双方向の相互作用が生まれる：グローバルリズムがエージェントを駆動し（引き込み）、エージェントもグローバルリズムを駆動する（励起）。デルタバンドでスポーンする大音量の「キック」エージェントはデルタレゾネータを「鳴らし」、そのバンドに結合した他のエージェントを同期させる。

## 5.3 蔵本引き込み

`entrain` TemporalCore は結合振動子の蔵本スタイルモデルを使用する。

$$ \frac{d\theta_i}{dt} = \omega_i + \frac{K}{N} \sum_{j=1}^N \sin(\theta_j - \theta_i) $$

Conchordal では、「結合」$K$ は他のすべてのエージェントに直接ではなくグローバルな `NeuralRhythms` に対するものである（平均場近似）。

*   **感度**：各エージェントはどのバンド（デルタ、シータなど）を聴くかを決定する感度プロファイルを持つ。
*   **位相ロック**：エージェントは内部のアーティキュレーション位相をレゾネータの位相に合わせて調整する。

これにより創発的同期が生じる。ランダムな時間にスポーンされたエージェントは徐々にアタックをデルタまたはシータバンドのビートに合わせ、中央シーケンサーなしで首尾一貫したリズムパターンを作り出す。

# 6. システムアーキテクチャと実装詳細

Conchordal はリアルタイムオーディオ（レイテンシ < 10ms）の厳しい要件と重い数値解析（NSGT/畳み込み）を満たすため Rust で実装されている。アーキテクチャは並行、ロックフリーの設計パターンを使用する。

## 6.1 スレッディングモデル

アプリケーションは4つの主要なスレッドコンテキストを作成する：

1.  **オーディオスレッド（リアルタイム優先度）**：
    *   `audio/output.rs` で `cpal` により管理。
    *   **制約**：決してブロックしてはならない。Mutex なし、メモリ割り当てなし。
    *   **責任**：`Population` を反復し、すべてのアクティブエージェントで `render_wave` を呼び出し、出力をミックスし、ハードウェアバッファにプッシュする。ランドスケープの読み取り専用スナップショットから読み取る。

2.  **Harmonicity Worker（バックグラウンド優先度）**：
    *   `core/stream/harmonicity.rs` で定義。
    *   **責任**：スペクトルデータ（log2 振幅スペクトル）を受信し、Sibling Projection アルゴリズムを使用して調和性場を計算する。
    *   **更新サイクル**：分析完了時、ロックフリー SPSC チャネルを介して更新された調和性データをメインループに送信。

3.  **Roughness Worker（バックグラウンド優先度）**：
    *   `core/stream/roughness.rs` で定義。
    *   **責任**：オーディオチャンクを受信し、ERB 領域畳み込みを介して粗さ場を計算する。
    *   **更新サイクル**：別の SPSC チャネルを介して更新された粗さデータをメインループに送信。

4.  **App/GUI スレッド（メイン）**：
    *   `egui` ビジュアライザと `Rhai` スクリプティングエンジンを実行。
    *   **責任**：ユーザー入力の処理、ランドスケープの可視化（`ui/plots.rs`）、シナリオスクリプトの実行。コマンドアクション（例：`SpawnAgent`、`SetGlobalParameter`）を `Population` に送信。
    *   **DorsalStream**：リズム解析（`core/stream/dorsal.rs`）はメインループ内で同期的に実行され、オーディオチャンクを処理して `NeuralRhythms` 変調バンク用のリズムエネルギーメトリクス（e_low、e_mid、e_high、flux）を抽出する。

## 6.2 データフローとダブルバッファリング

オーディオスレッドをロックせずにデータ一貫性を維持するため、Conchordal はランドスケープ用のマルチチャネル更新戦略を使用する。

1.  **Harmonicity Worker** はバックグラウンドで log2 スペクトルから調和性場を構築する。
2.  **Roughness Worker** はバックグラウンドでオーディオチャンクから粗さ場を構築する。
3.  **メインループ** は別々の SPSC チャネルを介して両ワーカーから更新を受信し、`LandscapeFrame` にマージする。
4.  `Population` は「現在の」ランドスケープを保持する。どちらかのワーカーから新しいデータが到着すると、メインループは対応する場を更新し、結合された協和性を再計算する。
5.  **DorsalStream** はリズムメトリクスを更新するためにオーディオを同期的に処理し、`landscape.rhythm` に格納する。

この分離されたアーキテクチャにより、分析ワーカーがリアルタイムからわずかに遅れても、オーディオスレッドは常に物理の一貫したスナップショットを参照する。各ワーカーは他をブロックすることなく独自のペースで動作できる。

## 6.3 コンダクター：Rhai によるスクリプティング

Conductor モジュールは人間のアーティストとエコシステム間のインターフェースとして機能する。[Rhai](https://rhai.rs/) スクリプト言語を組み込み、シミュレーションを制御するための高レベル API を公開する。

`ScriptHost` 構造体は内部 Rust 関数を Rhai コマンドにマッピングする：

*   `spawn_agents(tag, method, life, count, amp)`：`Action::SpawnAgents` にマップ。確率的スポーンクラウドの定義を可能にする（例：「200-400Hz 範囲で調和性密度を使用して5エージェントをスポーン」）。
*   `add_agent(tag, freq, amp, life)`：`Action::AddAgent` にマップ。特定の周波数で単一エージェントをスポーン。
*   `set_harmonicity(map)`：`Action::SetHarmonicity` にマップ。`mirror_weight` や `limit` などの物理パラメータのリアルタイム変調を可能にする。
*   `set_roughness_tolerance(value)`：協和性計算における粗さペナルティ重みを調整。
*   `set_habituation(weight, tau, max_depth)`：慣れメカニズムパラメータを設定。
*   `set_rhythm_vitality(value)`：DorsalStream リズムセクションの自己振動エネルギーを制御。
*   `wait(seconds)`：イベントループに制御を戻すノンブロッキング待機で、スクリプトがタイムラインを制御できる。
*   `scene(name)`：可視化とデバッグのための名前付きシーンの開始をマーク。
*   `remove(target)`：ターゲットパターンに一致するエージェントを削除（`"kick_*"` のようなワイルドカードをサポート）。

**シナリオ解析**：シナリオは `.rhai` または `.json5` ファイルからロードされる。この分離により、ユーザーは「マクロ構造」（物語のアーク、物理法則の変化）を作曲し、「ミクロ構造」（特定の音符とリズム）はエージェントのそれらの変化への適応から創発する。

# 7. ケーススタディ：創発的振る舞いの分析

以下の例は `samples/` ディレクトリから派生し、特定のパラメータ設定が複雑な音楽的振る舞いにどのようにつながるかを示す。

## 7.1 ケーススタディ：自己組織化リズム（`samples/02_mechanisms/rhythmic_sync.rhai`）

このスクリプトは時間の創発的量子化を示す。

1.  **フェーズ 1（種）**：単一の高エネルギーエージェント「Kick」が 60 Hz でスポーンされる。その周期的なアーティキュレーションが `NeuralRhythms` のデルタバンドレゾネータを励起する。
2.  **フェーズ 2（群れ）**：ランダムな位相を持つエージェントのクラウドがスポーンされる。
3.  **創発**：エージェントがデルタバンドに結合した `entrain` TemporalCore を使用するため、Kick によって確立されたリズムを感知する。数秒かけて位相がドリフトし、Kick に整列してロックする。結果は、群れに明示的にプログラムされていない同期パルス—結合振動子の物理から生じたものである。

## 7.2 ケーススタディ：鏡像二元性（`samples/04_ecosystems/mirror_dualism.rhai`）

このスクリプトは `mirror_weight` パラメータの構造的役割を探求する。

1.  **セットアップ**：アンカードローンが C4（261.63 Hz）に確立される。
2.  **状態 A（長調）**：`set_harmonicity(#{ mirror: 0.0 })`。システムは共通基音投影（上倍音列）を使用する。協和性を求めるエージェントは E4 と G4 周辺にクラスター化し、C メジャートライアドを形成する。
3.  **状態 B（短調）**：`set_harmonicity(#{ mirror: 1.0 })`。システムは共通上倍音投影（下倍音列）に切り替わる。ランドスケープの「重力」が反転する。エージェントは Ab3 と F3（C に対する短6度と完全4度の音程）に安定性を見出し、フリギア/短調のテクスチャを作り出す。これは Conchordal における「調性」が温度や重力のような操作可能な環境変数であることを示す。

## 7.3 ケーススタディ：ドリフトとフロー（`samples/04_ecosystems/drift_flow.rhai`）

このスクリプトはホップベースの移動ロジックを検証する。

1.  **アクション**：強い不協和エージェント（C#3）が強いアンカー（C2）の隣に配置される。
2.  **観察**：C#3 エージェントはピッチで離散的なホップを行う。調和性場に「引かれ」、フェードアウトして近くの調和的「井戸」（おそらく E3 または G3）にスナップする。
3.  **ダイナミクス**：慣れが有効な場合、エージェントは E3 に数秒落ち着き、その後「退屈」（局所協和性が低下）し、再び新しい安定した音程を見つけるためにホップする。結果は、引力と斥力の単純な物理則によって生成される終わりなき、繰り返しのないメロディである。

# 8. 結論

Conchordal は生体模倣計算オーディオの概念実証を成功裏に確立する。音楽理論の硬直した抽象（音符、グリッド、BPM）を連続的な生理学的モデル（`Log2Space`、ERB バンド、神経振動）に置き換えることで、音楽が構築されるのではなく、成長するシステムを作り出す。

技術アーキテクチャ—`Log2Space` 座標系と「Sibling Projection」アルゴリズムを基盤とする—は、この新しいパラダイムに堅牢な数学的基盤を提供する。Rust の使用により、これらの複雑な生物学的シミュレーションがリアルタイムで実行でき、ALife 研究と演奏用音楽楽器のギャップを橋渡しする。

Conchordal の将来の開発は、空間化（ランドスケープを3D空間に拡張）と進化遺伝学（成功したエージェントが `TimbreGenotype` を継承できるようにする）に焦点を当て、音と生命のアナロジーをさらに深化させる。

# 付録 A：主要システムパラメータ

| パラメータ | モジュール | 単位 | 説明 |
| :--- | :--- | :--- | :--- |
| `bins_per_oct` | `Log2Space` | Int | 周波数グリッドの解像度（通常 48-96）。 |
| `sigma_cents` | `Harmonicity` | Cents | 調和ピークの幅。低いほど厳格な音程。 |
| `mirror_weight` | `Harmonicity` | 0.0-1.0 | 上倍音（長調）と下倍音（短調）重力のバランス。 |
| `habituation_tau` | `Landscape` | Seconds | 聴覚疲労/飽きの時定数。 |
| `roughness_k` | `Landscape` | Float | 適応度関数における不協和ペナルティの重み。 |
| `vitality` | `DorsalStream` | 0.0-1.0 | リズムセクションの自己振動エネルギー。 |
| `persistence` | `ModulationCore` | 0.0-1.0 | エージェントの移動/変化への抵抗。 |

# 付録 B：数学的要約

**協和性適応度関数：**
$$ C(f,t) = \underbrace{H(f,t)}\_{\text{Harmonicity}} - k \cdot \underbrace{R(f,t)}\_{\text{Roughness}} - \underbrace{\int_{-\infty}^t E(f,\tau)e^{-(t-\tau)/\tau_{hab}} d\tau}\_{\text{Habituation}} $$

**調和性投影（Sibling アルゴリズム）：**
$$ H[i] = (1-\alpha)\sum_m \left( \sum_k A[i+\log_2(k)] \right)[i-\log_2(m)] + \alpha \sum_m \left( \sum_k A[i-\log_2(k)] \right)[i+\log_2(m)] $$

**粗さ畳み込み：**
$$ R(z) = \int A(\tau) \cdot K_{plomp}(|z-\tau|_{ERB}) d\tau $$