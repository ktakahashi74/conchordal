+++
title = "Technical Note: The Physics of Conchordal"
description = "A deep dive into the psychoacoustic algorithms, logarithmic signal processing, and artificial life strategies powering the Conchordal ecosystem."
template = "page.html"
[extra]
source_commit = "57a163c"
author = "Koichi Takahashi"
last_updated = "2026-02-17"
source_version = "0.2.0"
source_snapshot = "2026-02-17T23:09:53+09:00"
generated_by = "claude-opus-4-5-20251101"
+++

# 1. はじめに:生物音響パラダイム

Conchordalは、生成音楽と計算音響における既存の規範からの根本的な乖離を表している。従来のシステムが記号操作に依存し、量子化されたピッチ(MIDI、平均律)と離散化された時間(BPM、小節)のグリッド上で動作するのに対し、Conchordalは聴覚知覚の連続的で生物学的に基づいたシミュレーションとして機能する。音楽構造は抽象的な作曲の産物ではなく、音響的生存の創発的特性であるという立場をとっている。

本技術ノートは、システムのアーキテクチャ、信号処理アルゴリズム、人工生命戦略の網羅的参考資料として機能する。Conchordalが心理音響学の原理—特に臨界帯域理論、仮想ピッチ知覚、神経同調—を自律的エコシステムのダイナミクスとどのように統合しているかを詳述する。この環境において、音は生命体、代謝、感覚処理能力、敵対的なスペクトル地形を航行する自律性を持つ「Individual」として扱われる。

システムの創発的振る舞いは統一された適応度関数によって駆動される:協和性の追求である。Conchordalエコシステム内のエージェントは事前に書かれた楽譜に従わない。代わりに、「スペクトル快適性」—感覚的粗さの最小化として定義される—と「調波安定性」、すなわち仮想根音強度の最大化を達成するために、継続的に環境を分析する。その結果、決定論的シーケンシングではなく物理法則の相互作用を通じて、ハーモニー、リズム、音色が有機的に進化する自己組織化されたサウンドスケープが生まれる。

本文書は、Conchordalアーキテクチャの3つの基盤的柱を探求する:

1. **心理音響座標系**:線形ヘルツと整数MIDIノートを置き換える`Log2Space`とERBスケールの数学的枠組み。
2. **認知ランドスケープ**:生オーディオストリームから粗さ($R$)と調波性($H$)フィールドを計算するリアルタイムDSPパイプライン。
3. **生命エンジン**:オーディオエンティティの代謝、移動、神経同調を支配するエージェントベースのモデル。

# 2. 心理音響座標系

Conchordalにおける重要な革新は、内部処理において線形周波数スケール($f$)を拒否することである。人間の聴覚知覚は本質的に対数的である。ピッチ間隔の知覚は差分ではなく周波数比に基づいている。これを正確かつ効率的にモデル化するため、Conchordalは蝸牛のトノトピック地図に計算グリッドを整合させるカスタム座標系`Log2Space`を確立する。

## 2.1 Log2空間の基礎

`Log2Space`構造体は、システム内のすべてのスペクトル解析、カーネル畳み込み、エージェント配置のバックボーンとして機能する。物理的周波数領域($f$ Hz)を知覚的対数領域($l$)にマッピングする。

### 2.1.1 数学的定義

ヘルツから内部対数座標への変換は、周波数の2を底とする対数として定義される。この選択は意図的である:底2において、1.0の増分はちょうど1オクターブに対応し、これはピッチ知覚における最も基本的な音程である。

$$ l(f) = \log_2(f) $$

オーディオスレッドの合成パラメータを導出するために使用される逆変換は次の通り:

$$ f(l) = 2^l $$

座標空間は解像度パラメータ`bins_per_oct`($B$)によって定義されるグリッドに離散化される。このパラメータはシミュレーションの粒度を決定する。典型的な値$B=48$または$B=96$は、連続的なピッチグライドと微分音的変化に十分な半音以下の解像度を提供する。ステップサイズ$\Delta l$はスペクトル範囲全体で一定である:

$$ \Delta l = \frac{1}{B} $$

### 2.1.2 グリッド構築とインデックス化

`Log2Space`構造体は、構成された範囲$[f_{min}, f_{max}]$をカバーするすべてのビンの中心周波数を事前計算する。ビン数$N$は完全なカバレッジを保証するように決定される:

$$ N = \lfloor \frac{\log_2(f_{max}) - \log_2(f_{min})}{\Delta l} \rfloor + 1 $$

システムはDSP操作中の$O(1)$アクセスのため2つの並列ベクトルを維持する:

* `centers_log2`:対数座標$l_i = \log_2(f_{min}) + i \cdot \Delta l$。
* `centers_hz`:事前計算された線形周波数$f_i = 2^{l_i}$。

この事前計算は、スペクトルカーネルの内部ループ内での高コストな`log2`と`pow`呼び出しの必要性を排除し、リアルタイムパフォーマンスに不可欠である。メソッド`index_of_freq(hz)`は量子化ロジックを提供し、任意の浮動小数点周波数を最も近いビンインデックスにマッピングする。

## 2.2 定Q帯域幅特性

`Log2Space`は本質的にスペクトル全体で定Q(定品質係数)特性を強制する。信号処理用語において、$Q$は中心周波数と帯域幅の比として定義される:$Q = f / \Delta f$。

線形システム(標準FFTなど)では、$\Delta f$は定数であり、$Q$が周波数とともに増加することを意味する。`Log2Space`では、$i$番目のビンの帯域幅$\Delta f_i$は中心周波数$f_i$に比例してスケールする。この特性は人間の聴覚システムの周波数選択性を模倣し、周波数が増加するにつれて耳の周波数分解能力が(絶対Hz項で)低下する。この整合により、Conchordalは計算リソースを効率的に割り当てることができる—高周波数では高時間分解能を使用し、低周波数では高スペクトル分解能を使用する—手動のマルチレート処理なしで。

## 2.3 等価矩形帯域幅(ERB)スケール

`Log2Space`がピッチ関係(オクターブ、調波)を処理する一方で、耳の臨界帯域を完全にモデル化するわけではない。臨界帯域は純粋な対数マッピングが示すよりも低周波数で広い。感覚的粗さ(不協和音)を正確に計算するため、ConchordalはGlasberg & Moore(1990)モデルに基づく等価矩形帯域幅(ERB)スケールを実装している。

`core/erb.rs`モジュールは粗さカーネルによって使用される変換関数を提供する。周波数$f$(Hz)からERBレート単位$E$への変換は次式で与えられる:

$$ E(f) = 21.4 \log_{10}(0.00437f + 1) $$

周波数$f$における臨界帯域の帯域幅は:

$$ BW_{ERB}(f) = 24.7(0.00437f + 1) $$

このスケールは`Log2Space`とは区別される。`Log2Space`がピッチと調波性のための領域(関係がオクターブ不変である場所)である一方、粗さ計算は干渉を評価するためにスペクトルエネルギーをERB領域にマッピングする必要がある。システムは事実上スペクトルの二重ビューを維持している:調波テンプレート用の厳密な対数ビューと、不協和評価用の心理音響ビュー。

# 3. 聴覚ランドスケープ:環境の解析

「ランドスケープ」はConchordalの中心的なデータ構造である。すべてのエージェントの共有環境として機能し、すべての周波数ビンの心理音響的「ポテンシャル」を表す動的スカラーフィールドである。エージェントは互いに直接相互作用しない。ランドスケープと相互作用し、ランドスケープが全母集団のスペクトルエネルギーを集約する。これにより、シミュレーションの複雑さをエージェント数から切り離す($O(N)$対$O(N^2)$)。

ランドスケープは解析ワーカーによってオーディオフレーム(またはブロック)ごとに更新される。2つの主要メトリクスを統合する:

* **粗さ($R$)**:近接する部分音間の急速なビートによって引き起こされる感覚的不協和音。
* **調波性($H$)**:仮想ピッチ強度とスペクトル周期性の測定値。

両メトリクスは$[0, 1]$範囲に正規化される。正味の協和性は2段階で計算される:線形スコアに続いてシグモイド正規化。

**線形協和性スコア:**

$$ C_{score} = \alpha_h \cdot H_{01} - w(H_{01}) \cdot R_{01} $$

ここで$\alpha_h$は調波性重みであり、$w(H_{01})$は調波性依存の粗さ重みである:

$$ w(H_{01}) = w_0 + w_1 \cdot (1 - H_{01}) $$

これは調波性が低いときに粗さがより重くペナルティを課すことを意味する—調波構造を欠く領域では、中程度の粗さでさえコストが高く、強い調波領域はより多くの粗さを許容する。

**シグモイド状態マッピング:**

$$ C_{state} = \sigma(\beta \cdot (C_{score} - \theta)) $$

ここで$\sigma(x) = 1/(1+e^{-x})$は標準シグモイド、$\beta$はゲイン(急峻さ)を制御し、$\theta$は閾値(中心点)である。結果として得られる$C_{state} \in [0, 1]$は、エージェントがピッチ選択と代謝に使用する最終協和性値である。

個々のエージェントは、エージェントごとの退屈と親密さを追跡し、ピッチ選択中に追加のスコア調整を提供する独自の知覚コンテキスト(`PerceptualContext`)を維持する。

## 3.1 非定常ガボール変換(NSGT)

`Log2Space`にスペクトルデータを投入するため、Conchordalは非定常ガボール変換(NSGT)のカスタム実装を使用する。固定ウィンドウサイズを使用する短時間フーリエ変換(STFT)とは異なり、NSGTはセクション2.2で導出された定Q特性を維持するためにウィンドウ長$L$を周波数に反比例して変化させる。

### 3.1.1 カーネルベースのスペクトル解析

`core/nsgt_kernel.rs`の実装は、この変換を効率的に実行するためにスパースカーネルアプローチを利用する。各対数周波数帯域$k$に対して、時間領域カーネル$h_k$が事前計算される。このカーネルは、帯域の中心周波数$f_k$での複素正弦波と長さ$L_k \approx Q \cdot f_s / f_k$の周期的ハンウィンドウ$w_k$を結合する。

$$ h_k[n] = w_k[n] \cdot e^{-j 2\pi f_k n / f_s} $$

これらのカーネルは初期化中に周波数領域($K_k[\nu]$)に変換される。パフォーマンスを最適化するため、システムはこれらの周波数カーネルをスパース化し、重要なエネルギーを持つビンのみを保存する。

実行時、システムは入力オーディオバッファに単一のFFTを実行してスペクトル$X[\nu]$を取得する。帯域$k$の複素係数$C_k$は、周波数領域での内積を介して計算される:

$$ C_k = \frac{1}{N_{fft}} \sum_{\nu} X[\nu] \cdot K_k^*[\nu] $$

この「1つのFFT、多数のカーネル」アプローチにより、Conchordalは各帯域に対して個別のDFTを計算したり再帰フィルタバンクを使用したりする計算オーバーヘッドなしで、20Hzから20kHzをカバーする高解像度の対数間隔スペクトルを生成できる。

### 3.1.2 リアルタイム時間平滑化

生のスペクトル係数$C_k$は、オーディオ入力の確率的性質(特にノイズベースのエージェント)により高い分散を示す。エージェントがサンプリングできる安定したフィールドを作成するため、`RtNsgtKernelLog2`構造体はNSGTを時間平滑化層でラップする。

帯域ごとのリーキー積分器(指数平滑化)を実装する。重要なことに、時定数$\tau$は周波数依存である。ゆっくりと進化する低周波数は長い$\tau$で平滑化され、過渡的な詳細を運ぶ高周波数は短い$\tau$を持つ。

$$ y_k[t] = (1 - \alpha_k) \cdot |C_k[t]| + \alpha_k \cdot y_k[t-1] $$

ここで平滑化係数$\alpha_k$はフレーム間隔$\Delta t$から導出される:

$$ \alpha_k = e^{-\Delta t / \tau(f_k)} $$

これは耳の「積分時間」をモデル化し、ランドスケープが瞬間的信号パワーではなく心理音響的知覚を反映することを保証する。

## 3.2 粗さ($R$)計算:Plomp-Leveltモデル

粗さは、同じ臨界帯域内に入るが単一の音色として知覚されるほど十分に近くないスペクトル成分の干渉によって引き起こされる「荒さ」または「バズ音」の感覚である(ビート)。ConchordalはERB領域での畳み込みを介してPlomp-Leveltモデルの変形を実装している。

### 3.2.1 干渉カーネル

計算の核心は、`core/roughness_kernel.rs`で定義される粗さカーネルである。このカーネル$K_{rough}(\Delta z)$は、$\Delta z$ ERBだけ分離された2つの部分音間の干渉曲線をモデル化する。曲線は部分音が分離するにつれて急速に上昇し、約0.25 ERBでピーク(最大粗さ)に達し、その後さらに分離すると減衰するペナルティを作成する。

実装はこの形状を生成するためにパラメータ化関数`eval_kernel_delta_erb`を使用する:

$$ g(\Delta z) = e^{-\frac{\Delta z^2}{2\sigma^2}} \cdot (1 - e^{-(\frac{\Delta z}{\sigma_{suppress}})^p}) $$

第2項は、$\Delta z \to 0$のときにカーネルがゼロになることを保証する抑制係数であり、単一の純音が自己粗さを生成することを防ぐ。

### 3.2.2 畳み込みアプローチ

すべてのスペクトルビンに対してペアワイズで粗さを計算する($N^2$複雑度)ことは、リアルタイムアプリケーションには計算上禁止的である。Conchordalは粗さ計算を線形畳み込みとして扱うことでこれを解決する。

1. **マッピング**:NSGTからの対数間隔振幅スペクトルが線形ERBグリッドにマッピング(または補間)される。
2. **畳み込み**:この密度$A(z)$が事前計算された粗さカーネル$K_{rough}$と畳み込まれる。

$$ R_{shape}(z) = (A * K_{rough})(z) = \int A(z-\tau) K_{rough}(\tau) d\tau $$

結果$R_{shape}(z)$は周波数$z$における生の「粗さ形状」を表す。これを正規化された適応度信号に変換するため、Conchordalは生理学的飽和マッピングを適用する。

### 3.2.3 生理学的飽和マッピング

畳み込みからの生の粗さ値は無制限の範囲を持つ。ハードクランピングではなく、Conchordalは聴覚知覚の圧縮非線形性をモデル化する飽和曲線を使用する。このマッピングは基準正規化された粗さ比を$[0, 1]$範囲に変換する。

**基準正規化**:システムは「典型的な」粗さレベルを表す基準値$r_{ref,peak}$と$r_{ref,total}$を維持する。基準正規化された比は:

$$ x_{peak}(u) = \frac{R_{shape}(u)}{r_{ref,peak}} $$

$$ x_{total} = \frac{R_{shape,total}}{r_{ref,total}} $$

**飽和パラメータ**:パラメータ`roughness_k`($k > 0$)は飽和曲線のショルダーを制御する。基準比$x = 1$は次にマッピングされる:

$$ R_{ref} = \frac{1}{1+k} $$

大きい$k$は同じ入力比に対して$R_{01}$を減少させ、システムを粗さに対してより寛容にする。

**区分的飽和マッピング**:正規化された粗さ$R_{01}$は基準正規化された比$x$から次のように計算される:

$$
R_{01}(x; k) = \begin{cases}
0 & \text{if } x \leq 0 \\
x \cdot \frac{1}{1+k} & \text{if } 0 < x < 1 \\
1 - \frac{k}{x+k} & \text{if } x \geq 1
\end{cases}
$$

この関数は$x = 1$で連続(両分岐が$\frac{1}{1+k}$を生成)であり、$x \to \infty$のとき漸近的に1に飽和する。区分構造は低粗さに対する線形応答(感度を保持)を保証し、極端な値を圧縮する(飽和を防ぐ)。

**数値的安全性**:実装はエッジケースを堅牢に処理する:

* $x = \text{NaN} \to 0$
* $x = +\infty \to 1$
* $x = -\infty \to 0$
* 非有限の$k$は$10^{-6}$として扱われる

協和性を求めるエージェントは$R_{01}$フィールドのピークを積極的に回避する。

## 3.3 調波性($H$):Sibling Projectionアルゴリズム

粗さがエージェントを不協和音から遠ざける(分離)一方、調波性($H$)は融合—一貫した和音と音色の作成—に向けて駆動する。Conchordalは、脳の「共通根音」検出(仮想ピッチ)メカニズムを完全に周波数領域で近似する「Sibling Projection」と呼ばれる新しいアルゴリズムを導入する。

### 3.3.1 概念:仮想根音

アルゴリズムは、周波数$f$での任意のスペクトルピークがその副調波($f/2, f/3, f/4 \dots$)における基本周波数(根音)の潜在的存在を暗示すると仮定する。複数のスペクトルピークが共通の副調波を共有する場合、その副調波は強い「仮想根音」を表す。

### 3.3.2 2パス投影

アルゴリズムは対数グリッドの整数特性を利用して、`Log2Space`スペクトル上で2パスで動作する:

1. **下方投影(根音探索)**:現在のスペクトルエンベロープが下方に「塗り広げ」られる。エネルギーを持つすべてのビン$i$に対して、アルゴリズムは整数$k \in \{1, 2, \dots, N\}$に対してビン$i - \log_2(k)$にエネルギーを追加する。

    $$ Roots[i] = \sum_k A[i + \log_2(k)] \cdot w_k $$

    ここで$w_k$は調波インデックス$k$で減衰する重み係数(例えば$k^{-\rho}$)であり、低次調波が高次調波よりも強く根音を暗示することを反映する。結果`Roots`はすべての周波数での仮想ピッチの強度を記述する。

2. **上方投影(調波共鳴)**:次にシステムは`Roots`スペクトルを上方に投影する。$f_r$に強い根音が存在する場合、そのすべての自然調波($f_r, 2f_r, 3f_r \dots$)に対して安定性を暗示する。

    $$ H[i] = \sum_m Roots[i - \log_2(m)] \cdot w_m $$

**創発的調性安定性**:200 Hzの単一音色を持つ環境を考える。

* **ステップ1(下)**:100 Hz($f/2$)、66.6 Hz($f/3$)、50 Hz($f/4$)などに根音を投影する。
* **ステップ2(上)**:100 Hz根音は100、200、300、400、500... Hzに安定性を投影する。
    * 300 Hzは100 Hz根音の完全5度である。
    * 500 Hzは100 Hz根音の長3度である。

したがって、西洋音楽理論のハードコードされた知識なしで、システムは調波級数の物理学の結果として、長3度と完全5度の関係で自然に安定性ピークを生成する。200 Hzのエージェントは300 Hzと500 Hzに「重力井戸」を作成し、他のエージェントを長三和音を形成するように誘う。

### 3.3.3 鏡像二元性:上音対下音

`core/harmonicity_kernel.rs`の実装には深遠なパラメータが含まれる:`mirror_weight`($\alpha$)。このパラメータは2つの異なる投影パスをブレンドする:

* **パスA(上音/長調)**:上記で説明した標準的な「下-上」投影。上音列に基づく重力を作成し、長調的調性を優遇する。
* **パスB(下音/短調)**:逆転した「上-下」投影。共通の上音を見つけて下音を投影する。これはパスAの理論的双対であり、短調またはフリギア調性(下音列)を優遇する。

$$ H_{final} = (1-\alpha)H_{overtone} + \alpha H_{undertone} $$

`mirror_weight`を変調することで、ユーザーは宇宙の基本物理学を長調中心から短調中心へ連続的に変形させ、それに応じてエコシステムがどのように再編成するかを観察できる。

# 4. 生命エンジン:エージェントと自律性

「生命エンジン」は、DSPランドスケープの上で実行されるエージェントベースのシミュレーション層である。「Individual」の母集団を管理し、そのライフサイクル、感覚処理、アクチュエーション(オーディオ合成)を処理する。

## 4.1 Individual アーキテクチャ

`Individual`構造体(`life/individual.rs`)はエコシステムの原子単位である。複数のコンポーネントで構成される:`AnySoundBody`アクチュエータ、`ArticulationWrapper`(`ArticulationCore`をラップ)、`PitchController`(`PitchCore`をラップ)、ノートレベルのタイミングを管理する`PhonationEngine`。Individual自体は統合層として機能し、ライフサイクル(代謝、エネルギー)、知覚コンテキスト、コンポーネントを直接結合せずに調整する制御プレーン信号を管理する。

### 4.1.1 SoundBody(アクチュエータ)

`SoundBody`トレイトはエージェントのサウンド生成能力を定義する。波形のレンダリングとそのスペクトルフットプリントのシステムへの投影(ランドスケープ更新用)を担当する。

* `SineBody`:純粋な正弦波音を合成する。
* `HarmonicBody`:基音と一連の部分音からなる複雑な音色を合成する。このボディは次のようなパラメータをエンコードする`TimbreGenotype`の概念を導入する:
    * `stiffness`:非調波性係数(部分音列の引き伸ばし)。
    * `brightness`:スペクトル傾斜(高次部分音の減衰)。
    * `comb`:偶数調波減衰。
    * `damping`:周波数依存減衰率。
    * `vibrato_rate` / `vibrato_depth`:LFOベースのピッチ変調。
    * `jitter`:有機的変動のための1/fピンクノイズFM強度。
    * `unison`:コーラスのような厚みのためのデチューンコピー量。
    * `mode`:調和的(整数倍)対金属的(非整数比)。

`HarmonicBody`は音色の進化を可能にする。高い剛性を持つエージェントは純粋に調波的なランドスケープで生存が困難になるかもしれず、その非調波部分音が母集団と衝突しないユニークな「スペクトルニッチ」を求めることを余儀なくされる。

### 4.1.2 コアスタック(アーティキュレーション、ピッチ)

振る舞いは焦点を絞ったコアに分割され、それぞれが別個のファイルで定義されて新しい戦略での容易な拡張を可能にする:

* **ArticulationCore(いつ/ゲート)** — `life/articulation_core.rs`:リズム、ゲーティング、エンベロープダイナミクスを管理する。バリアントには`KuramotoCore`(`NeuralRhythms`への蔵本様同期)、`SequencedCore`(固定期間エンベロープ)、`DroneCore`(ゆっくりとした揺動)が含まれる。ArticulationCoreはIndividualから制御プレーン信号を受信し、ゲートを開くか閉じるかを決定する。
* **PitchCore(どこ)** — `life/pitch_core.rs`:協和性、距離ペナルティ、音域重力、エージェントごとの知覚調整に基づいて対数周波数空間における次のターゲットを提案する。2つの実装が存在する:
    * `PitchHillClimbPitchCore`:現在のターゲット周辺の離散的候補セットを評価し、協和性からペナルティ(距離、音域重力、持続性バイアス、`PerceptualContext`からの知覚調整)を引いたもので各候補をスコアリングする。
    * `PitchPeakSamplerCore`:ランドスケープの協和性ピークからサンプリングし、より探索的な戦略を提供する。

    `PitchController`はPitchCoreをリターゲティングロジックと統合ウィンドウ管理でラップする。

### 4.1.3 制御プレーン信号:計画とエラー

Individualは直接結合ではなく2つの直交信号を通じてそのコアを調整する:

* **計画**:PitchCoreがターゲット(`TargetProposal`)を提案し、Individualが「計画された」状態—次のターゲット周波数、予想ジャンプ距離、顕著性—を維持する。これはエージェントの*意図*を表す。
* **エラー**:IndividualはSoundBodyの現在のピッチと計画されたターゲットの間の不一致(符号付きセント、絶対セント)を計算する。これは以前のアクションの*結果*を表し、観察または将来の拡張(例えば適応的アーティキュレーション)で利用可能である。重要なことに、PitchCoreはエラー信号を読まない—探索はフィードバックから切り離されたままである。

この分離により各コアは集中を保つ:PitchCoreはランドスケープを探索し、ArticulationCoreはエンベロープを形成し、Individualはタイミングと状態遷移を調整する。

## 4.2 ライフサイクルと代謝

Conchordalのエージェントは生物学的代謝をモデルにしたエネルギーダイナミクスによって支配される。`LifecycleConfig`は2つの存在モードを定義する:

* **減衰**:エージェントは固定の`initial_energy`プールで生まれる。時間とともにこのエネルギーを消費し(半減期)、ゼロに達すると死亡する。これはプラックや打楽器のような一過性の音をモデル化する。
* **持続**:エージェントは`metabolism_rate`(1秒あたりのエネルギー損失)を持ち、協和性依存の充電を介してエネルギーを得ることができる。
    * **充電**:これが重要なフィードバックループである。phonation攻撃ごとに得られるエネルギーは、`MetabolismPolicy`を介してエージェントの現在の協和性によってスケールされる。
    * **生存**:不協和な(低$C$)領域のエージェントは「飢える」—そのエネルギーが枯渇し、振幅が減少し、最終的に死亡する。協和な(高$C$)領域のエージェントは「食べる」—エネルギーを維持または獲得し、より大きく長く歌うことを可能にする。

このメカニクスはダーウィン的圧力を作成する:**協和性の生存**。調波関係を見つけたエージェントだけが生き残って聴かれるため、音楽構造が創発する。

## 4.3 ピッチリターゲティングロジック

エージェントは静的ではない。適応度を向上させるために周波数空間を移動する。実行層はリターゲットゲート(シータゼロクロッシングプラス統合ウィンドウ)を適用し、次にPitchCoreに次のターゲットを提案するよう求める。

1. **リターゲットゲート**:Individualは現在の周波数に基づいて時間を積分し、シータクロッシングがウィンドウと整列したときにのみ発火する。これによりリターゲティングがリズミカルでスケール感応的に保たれる。
2. **ピッチ提案**:PitchCore(例えば`PitchHillClimbPitchCore`)は現在のターゲット周辺の離散的候補セットを評価する。協和性からペナルティ(距離、音域重力、持続性バイアス、`PerceptualContext`からのエージェントごとの知覚調整)を引いたもので各候補をスコアリングする。提案には改善強度を反映する`salience`スコア(0..1)が含まれる。

### 4.3.1 ホップポリシー

ピッチ移動は連続的ポルタメントではなく**ホップ**ポリシーを使用する:

1. **フェードアウト**:ArticulationCoreがゲートを閉じ、振幅を無音にフェードする。
2. **スナップ**:Individualは新しいターゲットにSoundBodyのピッチを更新する(離散的ジャンプ)。
3. **フェードイン**:ゲートが再び開き、新しいピッチが鳴る。

**順序が重要**:スナップが発生するサンプルでは、協和性が評価される*前に*ピッチが更新され、ランドスケープスコアがエージェントの実際に鳴っている周波数を反映することを保証する。エラー信号は一貫性を保つために*スナップ前*の現在のピッチから計算される。将来スナップ後のエラーが必要な場合は、別個の信号として追加できる。

これらのタイミングに敏感な遷移は微妙な破損を防ぐために回帰テストで保護されている。

# 5. 時間ダイナミクス:神経リズム

Conchordalはマスタークロックやメトロノームの概念を回避する。代わりに、時間は神経振動(脳波)に着想を得た連続的変調フィールドによって構造化される。これは「空間」ランドスケープに対する「時間」の等価物である。

## 5.1 変調バンク

`NeuralRhythms`構造体は生理学的周波数帯域に調整された共鳴フィルタのバンクを管理する:

* **デルタ(0.5–4 Hz)**:エコシステムの巨視的「パルス」。この帯域にロックされたエージェントは長いフレーズレベルの音符を演奏する。
* **シータ(4–8 Hz)**:「アーティキュレーション」レート。音節的リズムと中速モチーフを支配する。
* **アルファ(8–12 Hz)**:「テクスチャ」レート。トレモロ、ビブラート、きらめき効果に使用される。
* **ベータ(15–30 Hz)**:「緊張」レート。不協和音や興奮に関連する高速フラッター。

## 5.2 活力と自己発振

各帯域は減衰調和振動子である共振器として実装される。重要なパラメータは`vitality`である。

* `Vitality = 0`:共振器は受動フィルタとして機能する。イベント(例えば大きなエージェントのスポーン)によって励起されたときにのみリングし、その後減衰する。
* `Vitality > 0`:共振器はアクティブゲインを持つ。入力がない場合でもリズミックサイクルを維持し、自己発振できる。

これは双方向相互作用を作成する:グローバルリズムがエージェントを駆動し(同調)、エージェントもグローバルリズムを駆動する(励起)。デルタ帯域にスポーンする大きな「キック」エージェントはデルタ共振器を「リングさせ」、その帯域に結合された他のエージェントを同期させる。

## 5.3 蔵本同調

`KuramotoCore` ArticulationCoreは結合振動子の蔵本様モデルを使用する。

$$ \frac{d\theta_i}{dt} = \omega_i + \frac{K}{N} \sum_{j=1}^N \sin(\theta_j - \theta_i) $$

Conchordalでは、「結合」$K$はすべての他のエージェントに直接ではなくグローバル`NeuralRhythms`に対してである(平均場近似)。

* **感度**:各エージェントはどの帯域(デルタ、シータなど)を聴くかを決定する感度プロファイルを持つ。
* **位相ロック**:エージェントは共振器の位相に合わせて内部アーティキュレーション位相を調整する。

これにより創発的同期が生じる。ランダムな時間にスポーンされたエージェントは徐々に攻撃をデルタまたはシータ帯域のビートに整列させ、中央シーケンサーなしで一貫したリズミックパターンを作成する。

# 6. システムアーキテクチャと実装詳細

Conchordalは、重い数値解析(NSGT/畳み込み)と並んでリアルタイムオーディオの厳格な要件(レイテンシ < 10ms)を満たすためにRustで実装されている。アーキテクチャは並行ロックフリー設計パターンを使用する。

## 6.1 スレッディングモデル

アプリケーションは、GUIイベントループに加えて3つの主要なスレッドコンテキストを作成する:

1. **オーディオスレッド(リアルタイム優先度)**:
    * `audio/output.rs`の`cpal`によって管理される。
    * **制約**:決してブロックしてはならない。Mutexなし、メモリ割り当てなし。
    * **責任**:ロックフリーリングバッファからモノサンプルをポップし、すべての出力チャネルにコピーする。`Limiter`(ソフトクリップまたはピークリミッタ)がインターリーブ出力にインプレースで適用される。

2. **解析スレッド(バックグラウンド優先度)**:
    * `core/analysis_worker.rs`で定義され、`core/stream/analysis.rs`から`AnalysisStream`を実行する。
    * **責任**:オーディオホップ(時間領域チャンク)を受信し、NSGTを実行してlog2パワースペクトルを生成し、その後単一パイプラインで調波性フィールド(Sibling Projection)と粗さフィールド(ERB領域畳み込み)の*両方*を計算する。
    * **更新サイクル**:解析が完了すると、有界SPSCチャネルを介して更新されたランドスケープスナップショットをワーカースレッドに送り返す。

3. **ワーカースレッド(シミュレーションループ)**:
    * `app.rs`で`"worker"`と命名される。
    * **責任**:メインシミュレーションループを実行する。各反復:解析結果を現在のランドスケープにマージし、Conductorイベントをディスパッチし、Population(ピッチリターゲティング、アーティキュレーション、代謝)を進め、`ScheduleRenderer`を介してオーディオをレンダリングし、`DorsalStream`(リズム抽出)にフィードし、モノサンプルをオーディオスレッド用のリングバッファにプッシュする。
    * **DorsalStream**:リズム解析(`core/stream/dorsal.rs`)はこのループ内で同期的に実行され、`NeuralRhythms`変調バンク用のリズミックエネルギーメトリクス(e_low, e_mid, e_high, flux)を抽出するためにオーディオチャンクを処理する。

4. **アプリ/GUIスレッド(メイン)**:
    * `eframe`/`egui`ビジュアライザを実行する。
    * **責任**:ユーザー入力を処理し、ランドスケープ(`ui/plots.rs`)を視覚化し、シミュレーションメタデータを表示する。有界チャネルを介してワーカースレッドから`UiFrame`スナップショットを受信する。

## 6.2 データフロー

オーディオスレッドをロックせずにデータ一貫性を維持するため、Conchordalはランドスケープに対してマルチチャネル更新戦略を使用する。

1. **ワーカースレッド**がオーディオをレンダリングし、各ホップを有界チャネルを介して**解析スレッド**に送信する。
2. **解析スレッド**が完全なNSGT + 粗さ + 調波性パイプラインを実行し、結果の`Landscape`スナップショットを送り返す。
3. **ワーカースレッド**が解析結果を現在の`LandscapeFrame`にマージし、結合された協和性フィールドを再計算する。
4. `Population`がピッチ選択、代謝、エージェントライフサイクルのために現在のランドスケープを評価する。
5. **DorsalStream**がワーカーループ内で同期的にオーディオを処理してリズムメトリクスを更新し、`landscape.rhythm`に保存される。
6. レンダリングされたモノオーディオが**オーディオスレッド**によって消費されるロックフリーリングバッファにプッシュされる。

この切り離されたアーキテクチャは、解析スレッドがリアルタイムより若干遅れる場合でも、オーディオスレッドが常に一貫したサンプルストリームを見ることを保証する。解析スレッドはNSGT時間連続性を維持するためにすべてのホップを順番に処理する。

## 6.3 Conductor: Rhaiを使用したスクリプティング

Conductorモジュールは人間のアーティストとエコシステム間のインターフェースとして機能する。[Rhai](https://rhai.rs/)スクリプト言語を埋め込み、シミュレーションを制御するための高レベルAPIを公開する。

`ScriptHost`構造体は内部Rust関数をRhaiコマンドにマッピングする:

* `derive(species)`:プリセット(`sine`、`harmonic`、`saw`、`square`、`noise`)から新しい種ハンドルを作成し、`amp`、`freq`、`brain`、`phonation`、`timbre`、`metabolism`、`adsr`、`pitch_mode`、`pitch_core`を構成するためのメソッドチェーンを可能にする。
* `create(species, count)`:種ハンドルからエージェントのグループを作成する。さらなる構成のための`GroupHandle`を返す。
* `.place(strategy)`:グループにスポーン戦略を割り当てる。戦略には`consonance(root_freq)`、`consonance_density(min, max)`、`random_log(min, max)`、`linear(start, end)`が含まれる。
* `wait(seconds)`:保留中のグループをコミットし、その後タイムラインカーソルを進める。これは時間構造を形成するための主要メカニズムである。
* `flush()`:タイムラインを進めずに保留中のグループをコミットする。
* `release(group)`:フェードアウトリリースのためにグループをマークする。
* `scene(name, callback)`:名前付きシーン境界をマークする。コールバック内で作成されたグループはシーン終了時に自動的にリリースされる。
* `play(callback)`:スコープブロックを実行—内部で作成されたグループは終了時にリリースされる。
* `parallel([callbacks])`:複数のブロックを並行して実行し(タイムライン分岐)、カーソルを最新のエンドポイントに進める。
* `set_harmonicity_mirror_weight(value)`:リアルタイムで`mirror_weight`パラメータを変調する。
* `set_roughness_k(value)`:粗さ飽和パラメータ$k$を調整する。
* `set_global_coupling(value)`:蔵本結合強度を制御する。
* `seed(value)`:再現可能な実行のためのランダムシードを設定する。

**シナリオ解析**:シナリオは`.rhai`ファイルから読み込まれる。この分離により、ユーザーは「マクロ構造」(ナラティブアーク、変化する物理法則)を構成できる一方、「ミクロ構造」(具体的な音符とリズム)はそれらの変化へのエージェントの適応から創発する。

# 7. ケーススタディ:創発的振る舞いの解析

`samples/`ディレクトリから導出される以下の例は、特定のパラメータ構成がどのように複雑な音楽的振る舞いにつながるかを示している。

## 7.1 ケーススタディ:自己組織化リズム(`samples/02_mechanisms/rhythmic_sync.rhai`)

このスクリプトは時間の創発的量子化を実証する。

1. **フェーズ1(シード)**:60 Hzに単一の高エネルギーエージェント「Kick」がスポーンされる。その周期的アーティキュレーションが`NeuralRhythms`のデルタ帯域共振器を励起する。
2. **フェーズ2(群れ)**:エージェントの雲がランダムな位相でスポーンされる。
3. **創発**:エージェントがデルタ帯域に結合された`KuramotoCore` ArticulationCoresを使用するため、Kickによって確立されたリズムを感知する。数秒の期間にわたって、それらの位相がドリフトしKickと整列してロックする。結果は群れに明示的にプログラムされていなかった同期パルスである—結合振動子の物理学から生じた。

## 7.2 ケーススタディ:鏡像二元性(`samples/04_ecosystems/mirror_dualism.rhai`)

このスクリプトは`mirror_weight`パラメータの構造的役割を探求する。

1. **セットアップ**:C4(261.63 Hz)にアンカードローンが確立される。
2. **状態A(長調)**:`set_harmonicity_mirror_weight(0.0)`。システムは共通根音投影(上音列)を使用する。協和性を求めるエージェントはE4とG4周辺にクラスタ化し、Cメジャートライアドを形成する。
3. **状態B(短調)**:`set_harmonicity_mirror_weight(1.0)`。システムは共通上音投影(下音列)に切り替わる。ランドスケープの「重力」が反転する。エージェントは今やAb3とF3(Cに対する短6度と完全4度の音程)で安定性を見出し、フリギア/短調テクスチャを作成する。これはConchordalにおける「調性」が温度や重力に似た操作可能な環境変数であることを実証している。

## 7.3 ケーススタディ:ドリフトとフロー(`samples/04_ecosystems/drift_flow.rhai`)

このスクリプトはホップベースの移動ロジックを検証する。

1. **アクション**:強く不協和なエージェント(C#3)が強いアンカー(C2)の隣に配置される。
2. **観察**:C#3エージェントはピッチの離散的ホップを行う。調波性フィールドによって「引っ張られ」、フェードアウトして近くの調波「井戸」(おそらくE3またはG3)にスナップする。
3. **ダイナミクス**:エージェントごとの退屈が有効な場合、エージェントはE3に数秒落ち着き、その後「退屈」し(知覚的適応により局所的協和性が低下)、新しい安定した音程を見つけるために再びホップアウェイする。これにより、引力と反発の単純な物理法則によって生成される、終わりのない非反復のメロディが生じる。

# 8. 結論

Conchordalは生体模倣計算オーディオの概念実証を成功裏に確立した。音楽理論の硬直した抽象(音符、グリッド、BPM)を連続的生理学的モデル(`Log2Space`、ERB帯域、神経振動)で置き換えることにより、音楽が構築されるのではなく育てられるシステムを作成する。

技術アーキテクチャ—`Log2Space`座標系と「Sibling Projection」アルゴリズムによって固定される—は、この新しいパラダイムに対する堅牢な数学的基盤を提供する。Rustの使用は、これらの複雑な生物学的シミュレーションがリアルタイムで実行できることを保証し、ALife研究と演奏可能な楽器の間のギャップを埋める。

Conchordalの将来の開発は、空間化(ランドスケープの3D空間への拡張)と進化的遺伝学(成功したエージェントが`TimbreGenotype`を引き継ぐことを許可)に焦点を当て、音と生命の間の類推をさらに深める。

# 付録A:主要システムパラメータ

| パラメータ | モジュール | 単位 | 説明 |
| :--- | :--- | :--- | :--- |
| `bins_per_oct` | `Log2Space` | Int | 周波数グリッドの解像度(典型的に48-96)。 |
| `sigma_cents` | `HarmonicityParams` | セント | 調波ピークの幅。低い=より厳格なイントネーション。 |
| `mirror_weight` | `HarmonicityParams` | 0.0-1.0 | 上音(長調)と下音(短調)重力のバランス。 |
| `roughness_k` | `LandscapeParams` | Float | 粗さマッピングの飽和パラメータ。デフォルト:$(1/0.7) - 1 \approx 0.4286$($x=1$が$\approx 0.7$にマッピングされるように)。 |
| `consonance_harmonicity_weight` | `LandscapeParams` | Float | 協和性スコアにおける調波性の重み($\alpha_h$)。 |
| `consonance_roughness_weight_floor` | `LandscapeParams` | Float | 粗さペナルティの床重み($w_0$)。 |
| `consonance_roughness_weight` | `LandscapeParams` | Float | 調波性依存粗さ重みの傾き($w_1$)。 |
| `c_state_beta` | `LandscapeParams` | Float | 協和性状態マッピングのシグモイドゲイン。 |
| `c_state_theta` | `LandscapeParams` | Float | 協和性状態マッピングのシグモイド閾値。 |
| `vitality` | `DorsalStream` | 0.0-1.0 | リズムセクションの自己発振エネルギー。 |
| `persistence` | `PitchHillClimbPitchCore` | 0.0-1.0 | エージェントの移動/変化への抵抗(ピッチ選択内のポリシーバイアス)。 |

# 付録B:数学的要約

**協和性適応度関数(線形スコア):**

$$ C_{score} = \alpha_h \cdot H_{01} - (w_0 + w_1 \cdot (1 - H_{01})) \cdot R_{01} $$

**協和性状態(シグモイド正規化):**

$$ C_{state} = \frac{1}{1 + e^{-\beta(C_{score} - \theta)}} $$

**粗さ飽和マッピング**(基準正規化された比$x$から$R_{01} \in [0,1]$へ):

$$
R_{01}(x; k) = \begin{cases}
0 & \text{if } x \leq 0 \\
x \cdot \frac{1}{1+k} & \text{if } 0 < x < 1 \\
1 - \frac{k}{x+k} & \text{if } x \geq 1
\end{cases}
$$

ここで$k$は`roughness_k`(デフォルト$\approx 0.4286$)。関数は$x=1$で連続であり、$x \to \infty$のとき1に飽和する。

**調波性投影(Siblingアルゴリズム):**
$$ H[i] = (1-\alpha)\sum_m \left( \sum_k A[i+\log_2(k)] \right)[i-\log_2(m)] + \alpha \sum_m \left( \sum_k A[i-\log_2(k)] \right)[i+\log_2(m)] $$

**粗さ畳み込み:**
$$ R_{shape}(z) = \int A(\tau) \cdot K_{plomp}(|z-\tau|_{ERB}) d\tau $$